# KITZ OS — Docker Compose
# Usage: docker compose up --build
#
# REQUIRED: Create a .env file with at least:
#   POSTGRES_PASSWORD=<strong-random-password>
#   JWT_SECRET=<random-64-char-hex>
#   DEV_TOKEN_SECRET=<random-64-char-hex>
#
# Generate secrets: openssl rand -hex 32
#
# All services connect via Docker network hostnames.

x-service-defaults: &service-defaults
  build:
    context: .
    dockerfile: Dockerfile.service
  restart: unless-stopped
  networks:
    - kitz-net

x-env-common: &env-common
  NODE_ENV: development
  DATABASE_URL: postgres://kitz:${POSTGRES_PASSWORD}@postgres:5432/kitz

services:
  # ── Database ──
  postgres:
    image: postgres:16-alpine
    restart: unless-stopped
    environment:
      POSTGRES_USER: kitz
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD}
      POSTGRES_DB: kitz
    volumes:
      - pgdata:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - kitz-net
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U kitz"]
      interval: 5s
      timeout: 5s
      retries: 5
    deploy:
      resources:
        limits:
          memory: 512M

  # ── Migrations ──
  migrate:
    <<: *service-defaults
    build:
      context: .
      dockerfile: Dockerfile.service
      args:
        SERVICE_DIR: kitz-schemas
    command: ["node", "--import", "tsx", "migrations/run.ts"]
    environment:
      <<: *env-common
    depends_on:
      postgres:
        condition: service_healthy
    restart: "no"
    deploy:
      resources:
        limits:
          memory: 256M

  # ── Gateway (port 4000) ──
  kitz-gateway:
    <<: *service-defaults
    build:
      args:
        SERVICE_DIR: kitz-gateway
    ports:
      - "4000:4000"
    environment:
      <<: *env-common
      PORT: 4000
      JWT_SECRET: ${JWT_SECRET}
      DEV_TOKEN_SECRET: ${DEV_TOKEN_SECRET}
      SUPABASE_URL: ${SUPABASE_URL:-}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:-}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GOOGLE_LOGIN_REDIRECT_URI: ${GOOGLE_LOGIN_REDIRECT_URI:-http://localhost:5173/login}
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:4000/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M
    depends_on:
      migrate:
        condition: service_completed_successfully

  # ── LLM Hub (port 4010) ──
  kitz-llm-hub:
    <<: *service-defaults
    build:
      args:
        SERVICE_DIR: kitz-llm-hub
    ports:
      - "4010:4010"
    environment:
      <<: *env-common
      PORT: 4010
      LOVABLE_API_KEY: ${LOVABLE_API_KEY:-}
      CLAUDE_API_KEY: ${CLAUDE_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      AI_API_KEY: ${AI_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      GEMINI_API_KEY: ${GEMINI_API_KEY:-}
      PERPLEXITY_API_KEY: ${PERPLEXITY_API_KEY:-}
      DEEPSEEK_API_KEY: ${DEEPSEEK_API_KEY:-}
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:4010/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M

  # ── Payments (port 3005) ──
  kitz-payments:
    <<: *service-defaults
    build:
      args:
        SERVICE_DIR: kitz-payments
    ports:
      - "3005:3005"
    environment:
      <<: *env-common
      PORT: 3005
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      PAYPAL_WEBHOOK_ID: ${PAYPAL_WEBHOOK_ID:-}
      YAPPY_WEBHOOK_SECRET: ${YAPPY_WEBHOOK_SECRET:-}
      BAC_WEBHOOK_SECRET: ${BAC_WEBHOOK_SECRET:-}
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3005/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M
    depends_on:
      migrate:
        condition: service_completed_successfully

  # ── WhatsApp Connector (port 3006) ──
  kitz-whatsapp-connector:
    <<: *service-defaults
    build:
      args:
        SERVICE_DIR: kitz-whatsapp-connector
    ports:
      - "3006:3006"
    environment:
      <<: *env-common
      PORT: 3006
      KITZ_OS_URL: http://kitz-os:3012
      DEV_TOKEN_SECRET: ${DEV_TOKEN_SECRET}
      SERVICE_SECRET: ${DEV_TOKEN_SECRET}
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3006/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
    depends_on:
      migrate:
        condition: service_completed_successfully

  # ── Email Connector (port 3007) ──
  kitz-email-connector:
    <<: *service-defaults
    build:
      args:
        SERVICE_DIR: kitz-email-connector
    ports:
      - "3007:3007"
    environment:
      <<: *env-common
      PORT: 3007
      RESEND_API_KEY: ${RESEND_API_KEY:-}
      SENDGRID_API_KEY: ${SENDGRID_API_KEY:-}
      FROM_EMAIL: ${FROM_EMAIL:-kitz@kitz.services}
      DEV_TOKEN_SECRET: ${DEV_TOKEN_SECRET}
      SERVICE_SECRET: ${DEV_TOKEN_SECRET}
      KITZ_OS_URL: http://kitz-os:3012
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3007/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M
    depends_on:
      migrate:
        condition: service_completed_successfully

  # ── Notifications Queue (port 3008) ──
  kitz-notifications-queue:
    <<: *service-defaults
    build:
      args:
        SERVICE_DIR: kitz-notifications-queue
    ports:
      - "3008:3008"
    environment:
      <<: *env-common
      PORT: 3008
      WA_CONNECTOR_URL: http://kitz-whatsapp-connector:3006
      EMAIL_CONNECTOR_URL: http://kitz-email-connector:3007
      COMMS_API_URL: http://comms-api:3013
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3008/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M
    depends_on:
      migrate:
        condition: service_completed_successfully

  # ── Content/Compliance Services (port 3010) ──
  kitz-services:
    <<: *service-defaults
    build:
      args:
        SERVICE_DIR: kitz-services
    ports:
      - "3010:3010"
    environment:
      <<: *env-common
      PORT: 3010
      LLM_HUB_URL: http://kitz-llm-hub:4010
      ELEVENLABS_AGENT_ID: ${ELEVENLABS_AGENT_ID:-}
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3010/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M

  # ── Admin Services (port 3011) ──
  admin-kitz-services:
    <<: *service-defaults
    build:
      args:
        SERVICE_DIR: admin-kitz-services
    ports:
      - "3011:3011"
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3011/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M
    environment:
      <<: *env-common
      PORT: 3011
      GATEWAY_URL: http://kitz-gateway:4000
      WA_CONNECTOR_URL: http://kitz-whatsapp-connector:3006
      KITZ_OS_URL: http://kitz-os:3012
      PAYMENTS_URL: http://kitz-payments:3005
      NOTIFICATIONS_URL: http://kitz-notifications-queue:3008
      WORKSPACE_MCP_URL: ${WORKSPACE_MCP_URL:-}
      WORKSPACE_MCP_KEY: ${WORKSPACE_MCP_KEY:-}
      SUPABASE_URL: ${SUPABASE_URL:-}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:-}
      WORKSPACE_SUPABASE_URL: ${WORKSPACE_SUPABASE_URL:-}
      WORKSPACE_SUPABASE_SERVICE_KEY: ${WORKSPACE_SUPABASE_SERVICE_KEY:-}
      GOD_MODE_USER_ID: ${GOD_MODE_USER_ID:-}
      DEV_TOKEN_SECRET: ${DEV_TOKEN_SECRET}
      ELEVENLABS_AGENT_ID: ${ELEVENLABS_AGENT_ID:-}
    depends_on:
      - kitz-gateway
      - kitz-whatsapp-connector

  # ── KITZ OS (port 3012) ──
  kitz-os:
    <<: *service-defaults
    build:
      args:
        SERVICE_DIR: kitz_os
    ports:
      - "3012:3012"
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3012/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 1G
    environment:
      <<: *env-common
      PORT: 3012
      CLAUDE_API_KEY: ${CLAUDE_API_KEY:-}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY:-}
      AI_API_KEY: ${AI_API_KEY:-}
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      AI_MODEL: ${AI_MODEL:-gpt-4o-mini}
      SUPABASE_URL: ${SUPABASE_URL:-}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:-}
      WORKSPACE_API_URL: http://workspace:3001
      WORKSPACE_MCP_URL: ${WORKSPACE_MCP_URL:-}
      WORKSPACE_MCP_KEY: ${WORKSPACE_MCP_KEY:-}
      GOD_MODE_USER_ID: ${GOD_MODE_USER_ID:-}
      BUSINESS_ID: ${BUSINESS_ID:-}
      WA_CONNECTOR_URL: http://kitz-whatsapp-connector:3006
      EMAIL_CONNECTOR_URL: http://kitz-email-connector:3007
      COMMS_API_URL: http://comms-api:3013
      KILL_SWITCH: ${KILL_SWITCH:-false}
      KITZ_BRAIN_URL: http://kitz-brain:3015
      DEV_TOKEN_SECRET: ${DEV_TOKEN_SECRET}
      SERVICE_SECRET: ${DEV_TOKEN_SECRET}
      CADENCE_PHONE: ${CADENCE_PHONE:-}
      CADENCE_EMAIL: ${CADENCE_EMAIL:-}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-}
      PAYPAL_WEBHOOK_ID: ${PAYPAL_WEBHOOK_ID:-}
      YAPPY_WEBHOOK_SECRET: ${YAPPY_WEBHOOK_SECRET:-}
      BAC_WEBHOOK_SECRET: ${BAC_WEBHOOK_SECRET:-}
      ELEVENLABS_API_KEY: ${ELEVENLABS_API_KEY:-}
      ELEVENLABS_VOICE_ID: ${ELEVENLABS_VOICE_ID:-21m00Tcm4TlvDq8ikWAM}
      ELEVENLABS_MODEL_ID: ${ELEVENLABS_MODEL_ID:-eleven_multilingual_v2}
      ELEVENLABS_AGENT_ID: ${ELEVENLABS_AGENT_ID:-}
      N8N_API_URL: http://n8n:5678
      N8N_API_KEY: ${N8N_API_KEY:-}
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GOOGLE_REDIRECT_URI: ${GOOGLE_REDIRECT_URI:-http://localhost:3012/api/kitz/oauth/google/callback}
    depends_on:
      - kitz-gateway
      - kitz-llm-hub
      - workspace

  # ── Workspace (port 3001) ──
  workspace:
    <<: *service-defaults
    build:
      args:
        SERVICE_DIR: workspace
    ports:
      - "3001:3001"
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3001/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
    environment:
      <<: *env-common
      PORT: 3001
      GATEWAY_URL: http://kitz-gateway:4000
      WA_CONNECTOR_URL: ${WA_CONNECTOR_URL:-http://kitz-whatsapp-connector:3006}
      JWT_SECRET: ${JWT_SECRET}
      DEV_TOKEN_SECRET: ${DEV_TOKEN_SECRET}
      SUPABASE_URL: ${SUPABASE_URL:-}
      SUPABASE_SERVICE_ROLE_KEY: ${SUPABASE_SERVICE_ROLE_KEY:-}
      WORKSPACE_MCP_URL: ${WORKSPACE_MCP_URL:-}
      WORKSPACE_MCP_KEY: ${WORKSPACE_MCP_KEY:-}
      ELEVENLABS_AGENT_ID: ${ELEVENLABS_AGENT_ID:-}
    depends_on:
      - kitz-gateway
      - kitz-whatsapp-connector

  # ── Comms API (port 3013) ──
  comms-api:
    <<: *service-defaults
    build:
      args:
        SERVICE_DIR: engine/comms-api
    ports:
      - "3013:3013"
    environment:
      <<: *env-common
      PORT: 3013
      TWILIO_ACCOUNT_SID: ${TWILIO_ACCOUNT_SID:-}
      TWILIO_AUTH_TOKEN: ${TWILIO_AUTH_TOKEN:-}
      TWILIO_PHONE_FROM: ${TWILIO_PHONE_FROM:-}
      EMAIL_CONNECTOR_URL: http://kitz-email-connector:3007
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3013/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M

  # ── Logs API (port 3014) ──
  logs-api:
    <<: *service-defaults
    build:
      args:
        SERVICE_DIR: engine/logs-api
    ports:
      - "3014:3014"
    environment:
      <<: *env-common
      PORT: 3014
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3014/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M

  # ── n8n Workflow Automation (port 5678) ──
  n8n:
    image: n8nio/n8n:1.76.1
    restart: unless-stopped
    networks:
      - kitz-net
    ports:
      - "5678:5678"
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:5678/healthz"]
      interval: 15s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 1G
    environment:
      DB_TYPE: postgresdb
      DB_POSTGRESDB_HOST: postgres
      DB_POSTGRESDB_PORT: 5432
      DB_POSTGRESDB_DATABASE: kitz
      DB_POSTGRESDB_USER: kitz
      DB_POSTGRESDB_PASSWORD: ${POSTGRES_PASSWORD}
      DB_POSTGRESDB_SCHEMA: n8n
      N8N_HOST: localhost
      N8N_PORT: 5678
      N8N_PROTOCOL: http
      WEBHOOK_URL: http://localhost:5678/
      GENERIC_TIMEZONE: America/Panama
      N8N_BASIC_AUTH_ACTIVE: "true"
      N8N_BASIC_AUTH_USER: ${N8N_AUTH_USER:-kitz}
      N8N_BASIC_AUTH_PASSWORD: ${N8N_AUTH_PASSWORD}
      KITZ_OS_URL: http://kitz-os:3012
      KITZ_DEV_SECRET: ${DEV_TOKEN_SECRET}
      WORKSPACE_URL: http://workspace:3001
      GATEWAY_URL: http://kitz-gateway:4000
    volumes:
      - n8n_data:/home/node/.n8n
    depends_on:
      postgres:
        condition: service_healthy
      kitz-os:
        condition: service_healthy

  # ── Brain (cron + HTTP classification service, port 3015) ──
  kitz-brain:
    build:
      context: .
      dockerfile: Dockerfile.brain
    restart: unless-stopped
    networks:
      - kitz-net
    ports:
      - "3015:3015"
    healthcheck:
      test: ["CMD-SHELL", "wget -q --spider http://localhost:3015/health"]
      interval: 10s
      timeout: 5s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 256M
    environment:
      <<: *env-common
      PORT: 3015
      GATEWAY_URL: http://kitz-gateway:4000
      LLM_HUB_URL: http://kitz-llm-hub:4010
      KITZ_OS_URL: http://kitz-os:3012
      DEV_TOKEN_SECRET: ${DEV_TOKEN_SECRET}
      MCP_URL: ${MCP_URL:-}
      MCP_API_KEY: ${MCP_API_KEY:-}
      BUSINESS_ID: ${BUSINESS_ID:-134f52d0-90a3-4806-a1bd-c37ef31d4f6f}
      CADENCE_PHONE: ${CADENCE_PHONE:-}
      CADENCE_EMAIL: ${CADENCE_EMAIL:-}
      DEFAULT_ORG_ID: ${DEFAULT_ORG_ID:-}
    depends_on:
      - kitz-gateway
      - kitz-llm-hub
      - kitz-os

networks:
  kitz-net:
    driver: bridge

volumes:
  pgdata:
  n8n_data:
